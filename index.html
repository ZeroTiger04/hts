<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZeroTiger Stable</title>
    
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #0b0e11;
            --bg-card: #1e2329;
            --bg-hover: #2b3139;
            --border: #252930;
            --text-primary: #eaecef;
            --text-secondary: #848e9c;
            --text-yellow: #fcd535;
            --up: #0ecb81;
            --down: #f6465d;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Binance Plex", Arial, sans-serif;
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* 헤더 */
        header {
            height: 50px; background-color: #181a20; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 20px; justify-content: space-between;
        }
        .logo { font-size: 1.3rem; font-weight: bold; color: var(--text-yellow); display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 1px; }

        /* 티커 바 */
        .ticker-bar {
            height: 60px; background-color: #161a1e; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 20px; gap: 20px; position: relative;
        }
        
        .symbol-selector { position: relative; cursor: pointer; }
        .current-symbol-box { display: flex; align-items: center; gap: 10px; font-size: 1.4rem; font-weight: bold; }
        .current-symbol-box:hover { color: var(--text-yellow); }
        .market-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; background: #333; color: #aaa; }
        .badge-spot { background: #fcd535; color: #000; }
        .badge-future { background: #ff5500; color: #fff; }

        /* 드롭다운 메뉴 */
        .dropdown-menu {
            display: none; position: absolute; top: 100%; left: 0; margin-top: 10px; width: 350px;
            background-color: var(--bg-card); border: 1px solid var(--border); border-radius: 4px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 999;
        }
        .dropdown-menu.show { display: block; }
        .tab-header { display: flex; border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 12px; cursor: pointer; font-weight: bold; color: var(--text-secondary); background: transparent; border: none; }
        .tab-btn.active { color: var(--text-yellow); border-bottom: 2px solid var(--text-yellow); background: var(--bg-hover); }
        .coin-list-container { max-height: 400px; overflow-y: auto; display: none; }
        .coin-list-container.active { display: block; }
        .menu-item { display: flex; justify-content: space-between; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #252930; }
        .menu-item:hover { background-color: var(--bg-hover); }

        /* 가격 정보 */
        .main-price { font-size: 1.4rem; font-weight: bold; font-family: 'Roboto', sans-serif; }
        .stat-group { display: flex; gap: 20px; }
        .stat-box { display: flex; flex-direction: column; font-size: 0.75rem; color: var(--text-secondary); }
        .stat-val { font-size: 0.8rem; color: var(--text-primary); margin-top: 3px; }
        .c-up { color: var(--up); } .c-down { color: var(--down); }

        /* 차트 레이아웃 (반응형) */
        .chart-layout { flex: 1; display: flex; flex-direction: column; background-color: var(--bg-body); position: relative; }
        #chart-area { flex: 4; width: 100%; position: relative; } /* 메인 (80%) */
        #rsi-area { flex: 1; width: 100%; border-top: 1px solid var(--border); position: relative; } /* RSI (20%) */

        .loading-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; font-size: 1rem; z-index: 10; }
        .legend { position: absolute; top: 10px; left: 10px; z-index: 5; font-size: 11px; font-family: 'Roboto'; pointer-events: none; }
        .legend-item { margin-right: 8px; font-weight: bold; }
        
    </style>
</head>
<body>

    <header>
        <div class="logo"><i class="fas fa-paw"></i> ZeroTiger</div>
        <div style="font-size:0.8rem; color:#666;">Stable Engine</div>
    </header>

    <div class="ticker-bar">
        <div class="symbol-selector" id="symbol-btn">
            <div class="current-symbol-box">
                <span id="display-symbol">BTC/USDT</span>
                <span id="market-badge" class="market-badge badge-spot">SPOT</span>
                <i class="fas fa-caret-down" style="font-size:0.8rem; color:#888;"></i>
            </div>
            <div class="dropdown-menu" id="dropdown">
                <div class="tab-header">
                    <button class="tab-btn active" onclick="switchTab(event, 'spot')">현물 (Spot)</button>
                    <button class="tab-btn" onclick="switchTab(event, 'future')">선물 (Futures)</button>
                </div>
                <div id="list-spot" class="coin-list-container active"></div>
                <div id="list-future" class="coin-list-container"></div>
            </div>
        </div>

        <div style="display:flex; align-items:center; gap:20px;">
            <div class="main-price" id="display-price">0.00</div>
            <div class="stat-group">
                <div class="stat-box"><span>Open</span><span class="stat-val" id="display-open">0.00</span></div>
                <div class="stat-box"><span>High</span><span class="stat-val" id="display-high">0.00</span></div>
                <div class="stat-box"><span>Low</span><span class="stat-val" id="display-low">0.00</span></div>
            </div>
        </div>
    </div>

    <div class="chart-layout">
        <div id="loading" class="loading-msg">Connecting to Stable Server...</div>
        
        <div id="chart-area">
            <div class="legend">
                <span class="legend-item" style="color:#ffa500">EMA(20)</span>
                <span class="legend-item" style="color:#00ff00">EMA(60)</span>
                <span class="legend-item" style="color:#ff0000">EMA(120)</span>
                <span class="legend-item" style="color:#0088ff">EMA(200)</span>
            </div>
        </div>
        
        <div id="rsi-area">
            <div class="legend" style="top:5px;">
                <span class="legend-item" style="color:#9e55ff">RSI(14)</span>
            </div>
        </div>
    </div>

    <script>
        // --- 1. 차트 엔진 초기화 (Lightweight Charts) ---
        const chartProps = {
            layout: { background: { color: '#0b0e11' }, textColor: '#848e9c' },
            grid: { vertLines: { color: '#1e2329' }, horzLines: { color: '#1e2329' } },
            timeScale: { timeVisible: true, borderColor: '#252930' },
            crosshair: { mode: 1 },
        };

        const mainChart = LightweightCharts.createChart(document.getElementById('chart-area'), {
            ...chartProps, rightPriceScale: { borderColor: '#252930', scaleMargins: { top: 0.1, bottom: 0.1 } }
        });
        const rsiChart = LightweightCharts.createChart(document.getElementById('rsi-area'), {
            ...chartProps, rightPriceScale: { borderColor: '#252930' }, timeScale: { visible: false }
        });

        const candleSeries = mainChart.addCandlestickSeries({
            upColor: '#0ecb81', downColor: '#f6465d',
            borderUpColor: '#0ecb81', borderDownColor: '#f6465d',
            wickUpColor: '#0ecb81', wickDownColor: '#f6465d',
        });

        // 지표 시리즈 (EMA 4개)
        const ema20 = mainChart.addLineSeries({ color: '#ffa500', lineWidth: 1, priceScaleId: 'right' });
        const ema60 = mainChart.addLineSeries({ color: '#00ff00', lineWidth: 1, priceScaleId: 'right' });
        const ema120 = mainChart.addLineSeries({ color: '#ff0000', lineWidth: 1, priceScaleId: 'right' });
        const ema200 = mainChart.addLineSeries({ color: '#0088ff', lineWidth: 1, priceScaleId: 'right' });
        
        // RSI 시리즈
        const rsiSeries = rsiChart.addLineSeries({ color: '#9e55ff', lineWidth: 1 });
        rsiChart.createPriceLine({ price: 70, color: '#888', lineWidth: 1, lineStyle: 2, axisLabelVisible: false });
        rsiChart.createPriceLine({ price: 30, color: '#888', lineWidth: 1, lineStyle: 2, axisLabelVisible: false });

        mainChart.timeScale().subscribeVisibleTimeRangeChange((range) => { rsiChart.timeScale().setVisibleRange(range); });
        
        window.addEventListener('resize', () => {
            const w = document.body.clientWidth;
            const h = document.body.clientHeight - 110;
            mainChart.resize(w, h * 0.8);
            rsiChart.resize(w, h * 0.2);
        });
        setTimeout(() => window.dispatchEvent(new Event('resize')), 100);

        // --- 2. 계산 함수 ---
        function calculateEMA(data, period) {
            const result = [];
            const k = 2 / (period + 1);
            let ema = data[0].close;
            for (let i = 0; i < data.length; i++) {
                if(i < period - 1) {
                    ema = data[i].close; result.push({ time: data[i].time, value: NaN }); 
                } else {
                    ema = data[i].close * k + ema * (1 - k);
                    result.push({ time: data[i].time, value: ema });
                }
            }
            return result;
        }

        function calculateRSI(data, period = 14) {
            let result = [];
            let gains = 0, losses = 0;
            for(let i = 1; i <= period; i++) {
                let change = data[i].close - data[i-1].close;
                if(change > 0) gains += change; else losses -= change;
            }
            let avgGain = gains / period; let avgLoss = losses / period;
            for(let i = 0; i < data.length; i++) {
                if(i <= period) { result.push({ time: data[i].time, value: NaN }); continue; }
                let change = data[i].close - data[i-1].close;
                let gain = change > 0 ? change : 0; let loss = change < 0 ? -change : 0;
                avgGain = (avgGain * (period - 1) + gain) / period;
                avgLoss = (avgLoss * (period - 1) + loss) / period;
                let rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
                result.push({ time: data[i].time, value: 100 - (100 / (1 + rs)) });
            }
            return result;
        }

        // --- 3. 데이터 로드 (Kraken API 사용 - 안정성 최우선) ---
        // Kraken Symbol Mapping (BTC -> XXBTZUSD)
        const krakenMap = {
            'btc': 'XXBTZUSD',
            'eth': 'XETHZUSD',
            'xrp': 'XXRPZUSD',
            'sol': 'SOLUSD',
            'doge': 'XDGUSD',
            'ada': 'ADAUSD'
        };

        let currentSymbolKey = 'btc';
        let currentType = 'spot';
        let updateInterval = null;

        async function loadMarket(key, type) {
            document.getElementById('loading').style.display = 'block';
            if(updateInterval) clearInterval(updateInterval);

            // 1. 과거 데이터 (REST API)
            const kSymbol = krakenMap[key];
            const url = `https://api.kraken.com/0/public/OHLC?pair=${kSymbol}&interval=60`; // 1시간봉

            try {
                const res = await fetch(url);
                const json = await res.json();
                
                if(json.error && json.error.length > 0) throw new Error(json.error);

                // Kraken returns object keys dynamically, find the array
                const pairKey = Object.keys(json.result).find(k => k !== 'last');
                const rawData = json.result[pairKey];

                const data = rawData.map(d => ({
                    time: d[0], // Kraken uses Seconds already
                    open: parseFloat(d[1]),
                    high: parseFloat(d[2]),
                    low: parseFloat(d[3]),
                    close: parseFloat(d[4]),
                }));

                // 차트 그리기
                candleSeries.setData(data);
                ema20.setData(calculateEMA(data, 20));
                ema60.setData(calculateEMA(data, 60));
                ema120.setData(calculateEMA(data, 120));
                ema200.setData(calculateEMA(data, 200));
                rsiSeries.setData(calculateRSI(data));

                document.getElementById('loading').style.display = 'none';

                // 헤더 업데이트 (최신 캔들 기준)
                const last = data[data.length - 1];
                updateHeader(last.close, last.open, last.high, last.low);

                // 2. 실시간 업데이트 (Polling 방식 - 가장 안정적)
                // WebSocket 대신 5초마다 API를 호출하여 최신 꼬리를 업데이트
                // (이 방식이 Client-only 환경에서 끊김 없이 가장 확실함)
                updateInterval = setInterval(async () => {
                    try {
                        const updateRes = await fetch(url + `&since=${data[data.length-2].time}`); 
                        const updateJson = await updateRes.json();
                        const updateData = updateJson.result[pairKey];
                        
                        if(updateData && updateData.length > 0) {
                            const latest = updateData[updateData.length - 1];
                            const candle = {
                                time: latest[0],
                                open: parseFloat(latest[1]),
                                high: parseFloat(latest[2]),
                                low: parseFloat(latest[3]),
                                close: parseFloat(latest[4])
                            };
                            candleSeries.update(candle);
                            updateHeader(candle.close, candle.open, candle.high, candle.low);
                        }
                    } catch(e) { console.log("Update skip"); }
                }, 5000); // 5초마다 갱신

            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerText = "Data Error. Try Refresh.";
            }
        }

        // --- UI Logic ---
        const coins = [
            { id: 'btc', n: 'BTC' }, { id: 'eth', n: 'ETH' },
            { id: 'xrp', n: 'XRP' }, { id: 'sol', n: 'SOL' },
            { id: 'doge', n: 'DOGE' }, { id: 'ada', n: 'ADA' }
        ];

        function createList(type, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            coins.forEach(c => {
                const item = document.createElement('div');
                item.className = 'menu-item';
                item.onclick = (e) => { e.stopPropagation(); selectCoin(c.id, c.n, type); };
                item.innerHTML = `<div><span style="font-weight:bold;">${c.n}/USDT</span> <span style="font-size:0.75rem; color:#666;">${type.toUpperCase()}</span></div>`;
                container.appendChild(item);
            });
        }
        createList('spot', 'list-spot');
        createList('future', 'list-future');

        window.switchTab = function(e, type) {
            e.stopPropagation();
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById('list-spot').classList.remove('active');
            document.getElementById('list-future').classList.remove('active');
            document.getElementById(`list-${type}`).classList.add('active');
        }

        function selectCoin(id, name, type) {
            currentSymbolKey = id;
            currentType = type;
            document.getElementById('display-symbol').innerText = `${name}/USDT`;
            const badge = document.getElementById('market-badge');
            badge.innerText = type==='spot'?"SPOT":"PERP";
            badge.className = type==='spot'?"market-badge badge-spot":"market-badge badge-future";
            document.getElementById('dropdown').classList.remove('show');
            loadMarket(id, type);
        }

        function updateHeader(price, open, high, low) {
            const p = parseFloat(price);
            const o = parseFloat(open);
            const change = ((p - o) / o) * 100;
            const color = change >= 0 ? 'c-up' : 'c-down';
            
            document.getElementById('display-price').innerText = p.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('display-price').className = `main-price ${color}`;
            
            // 상단바 정보 변경 (Change 대신 High/Low 등으로 활용 가능)
            document.getElementById('display-open').innerText = o.toLocaleString();
            document.getElementById('display-high').innerText = parseFloat(high).toLocaleString();
            document.getElementById('display-low').innerText = parseFloat(low).toLocaleString();
        }

        // 드롭다운 이벤트
        const btn = document.getElementById('symbol-btn');
        const dropdown = document.getElementById('dropdown');
        btn.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('show'); });
        document.addEventListener('click', (e) => {
            if (!btn.contains(e.target) && !dropdown.contains(e.target)) dropdown.classList.remove('show');
        });
        dropdown.addEventListener('click', (e) => e.stopPropagation());

        // 실행
        loadMarket('btc', 'spot');

    </script>
</body>
</html>